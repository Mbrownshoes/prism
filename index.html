<!DOCTYPE html>
<met charset="utf-8">
	<link rel="stylesheet" href="main.css"> 
<style>

#land {
	stroke: #fff;
}

.leg {
	font:12px sans-serif;
}

.g-summary {
  line-height: 1.35em;
  position: absolute;
  width: 340px;
  color: #333;
}

.axis .domain {
  fill: none;
  stroke: #000;
  stroke-opacity: .3;
  stroke-width: 10px;
  stroke-linecap: round;

}

.axis .halo {
  fill: none;
  stroke: #ddd;
  stroke-width: 8px;
  stroke-linecap: round;
}

.slider .handle {
  fill: #fff;
  stroke: #000;
  stroke-opacity: .5;
  stroke-width: 1.25px;
  pointer-events: none;

}

#slider {
	position: absolute;
	top: 300px;
}

</style>


<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.geo.tile.v0.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>

 <h1>British Columbia High-Resolution PRISM Climatology</h1>
<div id="slider">
</div>
<div class = "g-graphic">
</div>
<script>

queue()
	.defer(d3.json,"prov.json")
	.defer(d3.json,"newUs.json")
	.await(render);

d3.select(".g-graphic")
	.append("h2")
	.html("Average daily maximum temperature values for<br><strong>January</strong>")
	.attr("class","g-summary")


var width = 960,
	height = 600,
	sliderHeight = 30,
	sliderWidth = 260;

var margin = {top: 10, right: 10, bottom: 10, left: 10}

var colors = d3.scale.quantize()
	.range(["rgb(69,117,180)", "rgb(116,173,209)", "rgb(171,217,233)", "rgb(224,243,248)", "rgb(255,255,191)", "rgb(254,224,144)", "rgb(253,174,97)", "rgb(244,109,67)", "rgb(215,48,39)", "rgb(165,0,38)"]);

var legend_labels = ["-20", "-15", "-10", "-5", "0", "5", "10", "15", "20", "25"]

// var projection = d3.geo.albers()
// 	.rotate([96, 0]) 
// 	.center([-32, 53.9]) 
// 	.parallels([20, 60]) //dont change
// 	.scale(1970) 
// 	.translate([width / 2, height / 2]);

var path = d3.geo.path()
	.projection(null);

var svg = d3.select(".g-graphic")
	.append("svg")
	.attr("width", width)
	.attr("height", height);

var current = {"month":1};

var legend = svg.selectAll('g.legendEntry')
	.data(colors.range().reverse())
	.enter()
	.append("g").attr('class', 'legendEntry');

var sliderContainer = d3.select("#slider").append("svg")
      .attr("width", sliderWidth + margin.left + margin.right)
      .attr("height", sliderHeight + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top  + ")");

var x = d3.scale.linear()
      .domain([1, 12])
      .range([0, sliderWidth])
      .clamp(true);

var brushToMonth = d3.scale.threshold()
	.domain([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12])
	.range([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]);

var brush = d3.svg.brush()
	.x(x)
	.extent([current.month, current.month])
	.on("brush", brushed);

sliderContainer.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + sliderHeight / 2 + ")")
  .call(d3.svg.axis()
          .scale(x)
          .orient("bottom")
          .ticks(8)
          .tickFormat(function(d) { 
          	return d; })
          .tickSize(0)
          .tickPadding(12))
          .select(".domain")
          .select(function() { 
            return this.parentNode.appendChild(this.cloneNode(true)); 
          })
          .attr("class", "halo");

var slider = sliderContainer.append("g")
  .attr("class", "slider")
  .call(brush);

slider.selectAll(".extent, .resize").remove();

slider.select(".background").attr("height", sliderHeight);

var handle = slider.append("circle")
  .attr("class", "handle")
  .attr("transform", "translate(0," + sliderHeight / 2 + ")")
  .attr("r", 9);


function render(error, prov, newUs){
	
	if (error) {
	    loading.text("Sorry, there has been an error. " +
	                 "Please refresh and try again.");
	    console.log(error);
	  }

	BC = prov;
	us = newUs;

	// Draw the map for the first time
	slider.call(brush.event)
		.call(brush.extent([1, 1]))
		.call(brush.event);

	drawBackgroundMap();
	console.log(current.month)
	drawMap(current.month);

};


function drawBackgroundMap(){
	svg.selectAll("path")
		.data(topojson.feature(BC, BC.objects.prov).features)
		.enter()
		.append("path")
		.attr("d", path)
		.style("fill", function(d){
			if (d.properties.province == "British Columbia") {
				return "none"
			} else { 
				return "#ddd";
			}
		})
		.attr("id", "land");



	// add Alaska
	var alaskaState = us.objects.states.geometries.filter(function(d) { return d.id === 2; })[0];

	svg.append("path")
	  .datum(topojson.feature(us, alaskaState))
	  .attr("id", "land")
	  .attr("d", path)
	  .style("fill","#ddd");
};

function drawMap(map) {
	console.log(map)
	
	svg.selectAll("#clip").remove();

	svg.append("clipPath")
		.attr("id", "clip")
		.append("use")
		.attr("xlink:href", "#land");

	svg.append("image")
		.attr("clip-path", "url(#clip)")
		.attr("xlink:href", "band" + current.month +".png")
		.attr("width", width)
		.attr("height", height);

	svg.append("use")
		.attr("xlink:href", "#land");

};



// legend 
var ls_w = 40;
legend
	.append("rect")
	.attr("y", 570)
	.attr("x", function(d, i) {
		return (width - 240) - (i * ls_w) - 2*ls_w;
	})
	.attr("width", ls_w)
	.attr("height", 10)
	.style("fill", function(d) {
		return d;
	});

legend.append("text")
	.attr("y", 595)
	.attr("x", function(d, i) {
		return (width - 240) - (i * ls_w) - ls_w - 10;
	})
	.attr("class", "leg")
	.text(function(d,i) {

		if (i === 0)
			return legend_labels[colors.range().length - i-1] + "\xB0 C";
		else
			return legend_labels[colors.range().length - i-1];
	});




function brushed() {
	var value = brush.extent()[0];
	if (d3.event.sourceEvent) {
		value = x.invert(d3.mouse(this)[0]);
		
		brush.extent([value, value]);
	}
	handle.attr("cx", x(value));
	console.log(value)
	var brushDate = brushToMonth(value-1);
	console.log(value)
	
	if (brushDate != current.month) {
		current.month = brushDate;
		console.log(brushDate)
		drawMap(brushDate)
	}
}
</script>











